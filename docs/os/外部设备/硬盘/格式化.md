# 1. 格式化

### 如何理解格式化？

> 现代的计算机系统在使用上越来越简单，但操作者离底层却越来越远；本文试图用比较容易理解的“类比”的方法来理清其中的头绪，给你一个清晰的解答。
>
> 红砖相信大部分人都见过，但你是否知道红砖的制作过程呢？具体的步骤是这样的：
>
> 首先要取黏土，但不是任何黏土都行，比如农田里的粘土土质细腻，烧制之后不易开裂，强度也好，所以经常会在农田取土（也正是由于这点，农村取黏土烧红砖已经被禁止了，因为破坏土地）。
>
> 取土之后，就在黏土里掺水，在半干半湿的状态下反复锤炼，形成橡皮泥那样的可塑状态，再将其摊平；拿一个金属框，上面编织着纵横交错、形成一个个矩形网格的钢丝（想象羽毛球拍），把这个框从上往下压入摊平的黏土之中。此时钢丝切割粘土，就出现了一块块的矩形的砖头。
>
> 最后就是把砖头送入砖窑烧制，出来就是成品砖头了。
>
> 我们研究一下这个制作过程：“黏土”处于可塑的状态，所以说黏土是“不规则的”、“没有固定形状的”，或者说是“没有格式的”。而烧制出的砖头是矩形的，于是我们说，黏土“有了固定的形状”，或者说有了“格式”，也就是把黏土格式化为砖头。
>
> 砖头就这样诞生了，而它的使命也开始了。生产砖头的目的是盖房子，所以无数的砖头投入到建设之中去，成为了一座座风格迥异的建筑。
>
> 所以你注意到了，虽然输入的基本材料都是砖头，但建造出的房屋的外形却是千变万化。
>
> 于是我们又得出结论：
> 1. 砖头是有格式的，房屋也是有格式的，所以“砖头转变为房屋”的过程也是“格式化”，换句话说就是：把砖头格式化为房屋。
> 2. 虽然两者都有格式，但格式不同，复杂度也不一样，很明显砖头的格式很简单（或者说很“低级”），而房屋的格式很复杂（或者说很“高级”）。于是：
>     - 黏土变为砖头的过程，称之为“**低级格式化**”（因为出来的产品是格式很低级的砖头）
>     - 砖头变为房屋的过程，称之为“高级格式化”（因为出来的产品是格式很高级的房屋）

#### 低级格式化

> 类比到底为止，接下来进入正题。“磁盘”、“磁带”这些名字我们早就耳熟能详了。从名字上也可以看出，这种存储介质的工作原理是与磁场有关的。磁盘与磁带虽然物理介质不同，但读写数据的原理却是一模一样的。
>
> 在圆盘表面镀有纳米级别的磁性颗粒，既然带磁性，那么就有磁场方向。在磁盘刚刚被制造出来时候，NS磁场方向一片混乱，指向随机，此时的磁盘就像是“黏土”，处于可塑的状态。
>
> 通电之后圆盘开始高速旋转，做圆周运动（目前的家用硬盘是7200转/分钟），三角形摆臂在圆盘半径方向来回摆动，做径向运动，2个运动方向的组合，就是摆臂尖端的“磁头”在圆盘的不同的半径上画圈。（摆臂向外，磁头就画大圈，摆臂向内，磁头就画小圈）。
>
> 为啥要画圈呢？“磁头”其实就是电磁铁，通电以后产生磁场，由于磁头与磁盘表面靠得非常近，从而能按照人为的安排修改磁性颗粒的磁场指向。例如：S级朝上为1，N级朝上为0，那么把磁盘表面磁性颗粒的磁场指向修改为 SNSNSN 就代表了 101010，数据就写入磁盘了。按照某种固定的、重复的格式，把数据写入磁盘，形成一个个的扇状区域，称为**扇区**（这是数据读写的基本单元）；同半径的扇区组成的圆圈称之为**磁道**。
>
> 所以刚出厂的磁盘，磁性颗粒的磁极指向是随机的，可塑的，所以此时的磁盘是“没有格式”的。经过磁头的写入之后，磁性颗粒的磁极指向排列就变得有了规则（有了“格式”）。这种从无规则的磁极指向排列，变为有规则的磁极指向排列的过程，称之为**格式化**，也就是把无规则的磁盘格式化出有规则的扇区。
>
> 同时，比较砖头与扇区，砖头是最基本的建筑单元，扇区是最基本的数据读写单元；而且与砖头类似，砖头虽然有格式，但格式低级，扇区有格式，但格式也低级，所以更准确地说是**低级格式化**，因为出来的产品是格式低级的扇区。

#### 高级格式化

> 接下来，作为基本读写单元的扇区（砖头）就要参与建造“房屋”了，那就是文件系统。
>
> 要建设房屋，自然要看建筑图纸，不同的图纸造出的房屋的特点、功能各不相同。比如居家型房屋要求有卧室和厨卫，北方还需要有暖气，大落地窗等等。但如果是仓库，那就不用厨房了，一个门卫使用的小卧室和卫生间足以，但要求面积要很大，举架要高等等
>
> 那么，怎么样用扇区来建造文件系统这个“房屋”，从而让数据“入住”呢？其实就是格式化成不同类型的文件系统的过程，如：FAT32、NTFS、EXT4等。
>
> 文件系统是按照某种高级的逻辑组合的一堆扇区（就像房屋是按照某种高级逻辑组合的一堆砖头），自然它也有格式，而且是更高级的格式。
>
> 于是我们总结一下磁盘的格式化过程：**把初始的磁盘低级格式化成一堆扇区，再把这些扇区高级格式化为文件系统。**（从硬盘角度看，数据的基本读写单位是扇区，但从文件系统的角度看，基本读写单位是若干个扇区一组的簇）
>
> 而低级格式化因为涉及到一些非常底层的操作，如果处理不当会对硬盘造成故障，或者性能的下降，所以现代的机械硬盘在出厂之前都已经低级格式化完毕了，用户硬盘到手，扇区就已经存在，只需要再高级格式化出"文件系统"就可以了。


综上所述，一般磁盘的格式化指的是，
> **在磁盘或磁盘中的一个分区上初始化一个文件系统，即建立并初始化用于文件和磁盘空间管理的元数据。**


根据用户选定的文件系统（如：FAT32、NTFS、EXT4等），在磁盘的特定区域写入特定数据，以达到初始化磁盘或磁盘分区、清除原磁盘或磁盘分区中所有文件的一个操作。包括对主引导记录中分区表相应区域的重写、根据用户选定的文件系统，在分区中划出一片用于存放文件分配表、目录表等用于文件管理的磁盘空间，以便用户使用该分区管理文件。


### 关于格式化之后的磁盘容量
**磁盘控制器必须对磁盘进行格式化，然后才能在该磁盘上存储数据。**

格式化包括，用标识扇区的信息填写扇区之间的间隙，标识出表面有故障的柱面并且不适用它们，以及在每个区中预留出一组柱面作为备用，如果区中一个或多个柱面在磁盘使用过程中坏掉了，就可以使用这些备用的柱面。因为存在着这些写备用的柱面，所以磁盘制造商所说的格式化容量比最大容量要小。


### 参考

- [“格式化”到底是啥意思 - 向往美的文章 - 知乎](https://zhuanlan.zhihu.com/p/53765040)
- 6.1.2 磁盘存储 -《深入理解计算机系统 - 第3版》
