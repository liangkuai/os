# CAS

Compare And Swap，比较和交换。是一种原子操作。


### 作用

可用于在并发环境中实现不被打断的数据交换操作，从而避免多线程同时改写某一数据时由于执行顺序不确定性以及中断的不可预知性产生的数据不一致问题。


### 语义

> 该操作通过将内存中的值与指定数据进行比较，当数值一样时将内存中的数据替换为新的值。

也就是说，在并发环境下，我们想要把内存地址 addr 的值改成 new，并且在进入 CAS 操作前，我们获取到内存地址 addr 处的值是 old。利用 CAS 操作：

1. 如果当前内存地址 addr 处的值还是 old，就将值更新为 new；
2. 如果值不是 old 了，就不进行操作，不会更新内存的值。

**切记：上述两个步骤叫做 CAS 操作，是一个原子性操作。**


### 和版本控制机制区别

和版本控制机制相比，CAS 直接用新值操作，没有修改阶段。


### 代码示例

一个 CAS 操作的过程可以用以下 C 代码表示：

```c
int cas(long *addr, long old, long new)
{
    /* Executes atomically. */
    if(*addr != old)
        return 0;
    *addr = new;
    return 1;
}
```


### 问题

ABA 问题

CAS 操作需要在修改值的时候检查下值有没有发生变化，如果没有发生变化就更新，但是如果一个值原来是 A，变成了 B，又变成了 A，那么使用 CAS 操作进行检查时会发现它的值没有发生变化，但是实际上却变化了。


### 语言实现

CAS 操作基于 CPU 提供的原子操作指令实现。

对于 Intel X86 处理器，可通过在汇编指令前增加 LOCK 前缀来锁定系统总线，使系统总线在汇编指令执行时无法访问相应的内存地址。而各个编译器根据这个特点实现了各自的原子操作函数。

- C：C11 的头文件 `<stdatomic.h>`。由 GNU 提供了对应的 `__sync` 系列函数完成原子操作。
- C++11：STL提供了 `atomic` 系列函数。
- Java：`sun.misc.Unsafe` 提供 `compareAndSwap` 系列函数。
- C#：通过 `Interlocked` 方法实现。
- Go：通过 import "sync/atomic" 包实现。
