# 版本号机制

一般是在数据表中加上一个数据版本号 version 字段，表示数据被修改的次数。当数据被修改时，version 值会加一。

当前线程要更新数据值时，在读取数据的同时也会读取 version 值，在提交更新时，如果刚才读取到的 version 值和当前数据库中的 version 值相等时才更新。


### 示例

假设数据库中帐户信息表中有一个version字段，当前值为 1 ；而当前帐户余额字段（balance）为 100 。

1. 操作员 A 此时将其读出（version_a=1），并从其帐户余额中扣除 50（100-50）。
2. 在操作员 A 操作的过程中，操作员B 也读入此用户信息（version_b=1），并从其帐户余额中扣除 20（100 - 20）。
3. 操作员 A 完成了修改工作，version_a++（version_a=2），连同帐户扣除后余额（balance=50），提交至数据库更新，此时由于提交数据版本大于数据库记录当前版本，数据被更新，数据库记录 version 更新为 2。
4. 操作员 B 完成了操作，version_b++（version_b=2）试图向数据库提交数据（balance=80），但此时比对数据库记录版本时发现，操作员 B 提交的数据版本号为 2 ，数据库记录当前版本也为 2 ，不满足 “提交版本必须大于记录当前版本才能执行更新“ 的乐观并发控制策略，因此，操作员 B 的提交被驳回。

这样，就避免了操作员 B 用基于 version=1 的旧数据修改的结果覆盖操作员 A 的操作结果的可能。
